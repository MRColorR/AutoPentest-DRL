#!/usr/bin/env bash

# Update packages and install dependencies
sudo apt-get update
sudo apt-get install -y build-essential graphviz graphviz-dev graphviz-doc nmap texlive-font-utils default-jdk mariadb-server mariadb-client flex bison curl libcurl4-openssl-dev unixodbc-dev libmariadb-dev libpcre3 libpcre3-dev python3 python3-pip postgresql metasploit-framework
sudo apt full-upgrade -y

# Download the latest version of AutoPentest-DRL
TAG=$(curl -s https://api.github.com/repos/MRColorR/AutoPentest-DRL/releases/latest | grep tag_name | cut -d '"' -f 4)
curl -L "https://github.com/MRColorR/AutoPentest-DRL/archive/refs/tags/$TAG.tar.gz" -o "AutoPentest-DRL_$TAG.tar.gz"
tar -xzf "AutoPentest-DRL_$TAG.tar.gz"
rm "AutoPentest-DRL_$TAG.tar.gz"

# Enter the folder and create a Python virtual environment
cd "AutoPentest-DRL_$TAG"
python -m venv .
source bin/activate

# Install third-party tool dependencies
cd repos

# Download and install XSB
curl -L -o XSB.tar.gz https://xsb.sourceforge.net/downloads/XSB.tar.gz
tar -xzf XSB.tar.gz
rm XSB.tar.gz
cd XSB/build
./configure
makexsb
export PATH="$(pwd)/bin:$PATH"

# Download and install MulVAL
cd ..
TAG=$(curl -s https://api.github.com/repos/MRColorR/mulval/releases/latest | grep tag_name | cut -d '"' -f 4)
curl -L "https://github.com/MRColorR/mulval/archive/refs/tags/$TAG.tar.gz" -o "mulval_$TAG.tar.gz"
tar -xzf "mulval_$TAG.tar.gz"
rm "mulval_$TAG.tar.gz"
cd "mulval_$TAG"
make
export MULVALROOT="$(pwd)"
export PATH="$MULVALROOT/bin:$MULVALROOT/utils:$PATH"

# Go back to the main directory and install Python requirements
cd ../../
pip install -r requirements.txt

# Execute the logical test
python3 ./AutoPentest-DRL.py logical_attack
